// Mapping van image service category index naar categorie slug
const imageServiceIndexToCategorySlug: Record<number, string> = {
  0: "auto-s", // Voertuigen -> Auto's
  1: "fietsen", // Fietsen -> Fietsen
  2: "huis-en-inrichting", // Huis & Inrichting -> Huis & Inrichting
  3: "tuin-en-doe-het-zelf", // Tuin & Terras -> Tuin & Doe-het-zelf
  4: "elektronica", // Elektronica -> Elektronica
  5: "elektronica", // Computers -> Elektronica
  6: "kleding-en-accessoires", // Kleding -> Kleding & Accessoires
  7: "sport-en-vrije-tijd", // Sport & Hobby -> Sport & Vrije tijd
};

// Mapping van categorie slugs naar database IDs
const categorySlugToId: Record<string, number> = {
  "auto-s": 1, // Auto's
  "motoren-en-scooters": 2, // Motoren & Scooters
  "fietsen": 3, // Fietsen
  "caravans-en-kamperen": 4, // Caravans & Kamperen
  "watersport": 5, // Watersport
  "huis-en-inrichting": 6, // Huis & Inrichting
  "tuin-en-doe-het-zelf": 7, // Tuin & Doe-het-zelf
  "elektronica": 8, // Elektronica
  "gaming": 9, // Gaming
  "foto-en-video": 10, // Foto & Video
  "huishoudelijk": 11, // Huishoudelijk
  "kleding-en-accessoires": 12, // Kleding & Accessoires
  "sieraden-en-horloges": 13, // Sieraden & Horloges
  "beauty-en-gezondheid": 14, // Beauty & Gezondheid
  "kinderen-en-baby-s": 15, // Kinderen & Baby's
  "sport-en-vrije-tijd": 16, // Sport & Vrije tijd
  "muziek": 17, // Muziek
  "boeken-en-media": 18, // Boeken & Media
  "film-en-series": 19, // Film & Series
  "kunst-en-antiek": 20, // Kunst & Antiek
  "verzamelen": 21, // Verzamelen
  "dieren": 22, // Dieren
  "zakelijk": 23, // Zakelijk
  "bouw-en-gereedschap": 24, // Bouw & Gereedschap
  "horeca-en-keuken": 25, // Horeca & Keuken
  "agrarisch": 26, // Agrarisch
  "evenementen": 27, // Evenementen
  "reizen": 28, // Reizen
  "gratis-en-ruilen": 29, // Gratis & Ruilen
  "diensten": 30, // Diensten
  "software": 31, // Software
  "domotica": 32, // Domotica
  "audio-pro": 33, // Audio Pro
  "medisch-en-zorg": 34, // Medisch & Zorg
  "beveiliging": 35, // Beveiliging
  "energie": 36, // Energie
};

export interface DetectedCategory {
  categoryId: number;
  categorySlug: string;
  subcategorySlug?: string;
  confidence: number;
  detectedLabel?: string;
}

// Keywords mapping naar categorieën en subcategorieën
const categoryKeywords: Record<string, { categorySlug: string; subcategorySlug?: string; keywords: string[] }> = {
  // Auto's
  "auto": { categorySlug: "auto-s", subcategorySlug: "personenwagens", keywords: ["auto", "wagen", "personenwagen", "sedan", "hatchback", "stationwagen", "auto's", "wagens"] },
  "bestelwagen": { categorySlug: "auto-s", subcategorySlug: "bestelwagens", keywords: ["bestelwagen", "bestelwagens", "busje", "busjes", "van", "transporter"] },
  "oldtimer": { categorySlug: "auto-s", subcategorySlug: "oldtimers", keywords: ["oldtimer", "oldtimers", "klassieker", "klassiekers", "vintage auto", "historische auto"] },
  "motorfiets": { categorySlug: "auto-s", subcategorySlug: "motorfietsen", keywords: ["motorfiets", "motorfietsen", "motor", "motors", "motorrijwiel"] },
  "auto-onderdelen": { categorySlug: "auto-s", subcategorySlug: "auto-onderdelen", keywords: ["auto-onderdelen", "auto onderdelen", "autodelen", "wagenonderdelen", "car parts"] },

  // Fietsen
  "fiets": { categorySlug: "fietsen", subcategorySlug: "stadsfietsen", keywords: ["fiets", "fietsen", "rijwiel", "rijwielen", "twee wieler", "tweewieler"] },
  "racefiets": { categorySlug: "fietsen", subcategorySlug: "racefietsen", keywords: ["racefiets", "racefietsen", "koersfiets", "koersfietsen", "road bike", "roadbike", "wegfiets", "wegfietsen"] },
  "mountainbike": { categorySlug: "fietsen", subcategorySlug: "mountainbikes", keywords: ["mountainbike", "mountainbikes", "mtb", "bergfiets", "bergfietsen", "all mountain", "cross country"] },
  "ebike": { categorySlug: "fietsen", subcategorySlug: "e-bikes", keywords: ["e-bike", "ebike", "e bike", "elektrische fiets", "elektrische fietsen", "e-fiets", "e-fietsen"] },
  "brommer": { categorySlug: "fietsen", subcategorySlug: "brommers", keywords: ["brommer", "brommers", "scooter", "scooters", "bromfiets", "bromfietsen"] },
  "fiets-onderdelen": { categorySlug: "fietsen", subcategorySlug: "fiets-onderdelen", keywords: ["fiets-onderdelen", "fiets onderdelen", "fietsaccessoires", "fiets accessoires", "bike parts"] },

  // Huis & Inrichting
  "meubel": { categorySlug: "huis-en-inrichting", subcategorySlug: "meubels", keywords: ["meubel", "meubels", "meubilair", "tafel", "stoel", "kast", "bed", "bank"] },
  "verlichting": { categorySlug: "huis-en-inrichting", subcategorySlug: "verlichting", keywords: ["verlichting", "lamp", "lampen", "licht", "lichten", "spots", "led", "hanglamp"] },
  "decoratie": { categorySlug: "huis-en-inrichting", subcategorySlug: "decoratie", keywords: ["decoratie", "decoraties", "sieraden", "sier", "ornamenten", "decoratief", "vaas", "kussen"] },
  "keuken": { categorySlug: "huis-en-inrichting", subcategorySlug: "wonen-keuken", keywords: ["keuken", "kookgerei", "pannen", "servies", "bestek", "oven", "kookplaat"] },
  "huishoudtoestellen": { categorySlug: "huis-en-inrichting", subcategorySlug: "huishoudtoestellen", keywords: ["wasmachine", "droger", "koelkast", "oven", "magnetron", "stofzuiger", "huishoud apparaat"] },

  // Tuin & Terras
  "tuinmeubelen": { categorySlug: "tuin-en-doe-het-zelf", subcategorySlug: "tuinmeubelen", keywords: ["tuinmeubelen", "tuin meubels", "buitenmeubels", "buiten meubels", "terrassen", "tuinstoelen", "tuintafel"] },
  "tuingereedschap": { categorySlug: "tuin-en-doe-het-zelf", subcategorySlug: "tuingereedschap", keywords: ["grasmaaier", "heggenschaar", "tuinapparatuur", "tuingereedschap", "schop", "hark"] },
  "bbq": { categorySlug: "tuin-en-doe-het-zelf", subcategorySlug: "bbq", keywords: ["bbq", "barbecue", "grill", "grillen", "buitenkeuken", "buiten keuken"] },
  "zwembad": { categorySlug: "tuin-en-doe-het-zelf", subcategorySlug: "zwembad", keywords: ["zwembad", "zwembaden", "pool", "jacuzzi", "spa", "wellness"] },

  // Elektronica
  "televisie": { categorySlug: "elektronica", subcategorySlug: "tv", keywords: ["televisie", "tv", "televisies", "beeldscherm", "beeldschermen", "smart tv", "led tv", "oled"] },
  "audio": { categorySlug: "elektronica", subcategorySlug: "audio-hifi", keywords: ["audio", "hifi", "hi-fi", "muziek", "geluid", "speakers", "boxen", "versterker"] },
  "koptelefoon": { categorySlug: "elektronica", subcategorySlug: "headphones", keywords: ["koptelefoon", "koptelefoons", "headphones", "headset", "oortjes", "earbuds"] },
  "camera": { categorySlug: "elektronica", subcategorySlug: "cameras", keywords: ["camera", "camera's", "fotocamera", "videocamera", "digitale camera", "dslr"] },

  // Computers
  "laptop": { categorySlug: "elektronica", subcategorySlug: "laptops", keywords: ["laptop", "laptops", "notebook", "notebooks", "draagbare computer"] },
  "desktop": { categorySlug: "elektronica", subcategorySlug: "desktops", keywords: ["desktop", "desktops", "pc", "computer", "computer's", "toren", "tower"] },
  "randapparatuur": { categorySlug: "elektronica", subcategorySlug: "randapparatuur", keywords: ["printer", "scanner", "muis", "toetsenbord", "monitor", "webcam"] },
  "componenten": { categorySlug: "elektronica", subcategorySlug: "componenten", keywords: ["moederbord", "processor", "ram", "harddisk", "ssd", "videokaart"] },

  // Telefoons & Tablets
  "smartphone": { categorySlug: "elektronica", subcategorySlug: "smartphones", keywords: ["smartphone", "smartphones", "telefoon", "telefoons", "mobiel", "mobiele telefoon", "gsm", "iphone", "samsung"] },
  "tablet": { categorySlug: "elektronica", subcategorySlug: "tablets", keywords: ["tablet", "tablets", "ipad", "android tablet", "surface"] },
  "phone-accessoires": { categorySlug: "elektronica", subcategorySlug: "phone-accessoires", keywords: ["hoesje", "hoesjes", "oplader", "charger", "telefoon accessoires", "phone case"] },

  // Kleding
  "dames": { categorySlug: "kleding-en-accessoires", subcategorySlug: "dames", keywords: ["dames", "vrouw", "vrouwen", "dameskleding", "vrouwenkleding", "jurk", "bloes"] },
  "heren": { categorySlug: "kleding-en-accessoires", subcategorySlug: "heren", keywords: ["heren", "man", "mannen", "herenkleding", "mannenkleding", "broek", "shirt"] },
  "schoenen": { categorySlug: "kleding-en-accessoires", subcategorySlug: "schoenen", keywords: ["schoenen", "schoen", "laarzen", "sneakers", "sneakers", "boots", "sandals"] },
  "tassen": { categorySlug: "kleding-en-accessoires", subcategorySlug: "tassen-juwelen", keywords: ["tassen", "tas", "handtas", "rugzak", "koffer"] },

  // Kinderen & Baby's
  "kinderkleding": { categorySlug: "kinderen-en-baby-s", subcategorySlug: "kinderkleding", keywords: ["kinderkleding", "kinder kleding", "babykleding", "baby kleding"] },
  "kinderwagen": { categorySlug: "kinderen-en-baby-s", subcategorySlug: "kinderwagens", keywords: ["kinderwagen", "kinderwagens", "buggy", "wandelwagen", "maxicosi"] },
  "speelgoed": { categorySlug: "kinderen-en-baby-s", subcategorySlug: "speelgoed", keywords: ["speelgoed", "speelgoed", "speel dingen", "speelspullen", "lego", "speelgoed", "knuffel"] },

  // Sport & Fitness
  "fitness": { categorySlug: "sport-en-vrije-tijd", subcategorySlug: "fitnessapparatuur", keywords: ["fitnessapparatuur", "fitness apparatuur", "hometrainer", "crosstrainer", "gewichtheffen", "dumbbells"] },
  "teamsport": { categorySlug: "sport-en-vrije-tijd", subcategorySlug: "teamsport", keywords: ["voetbal", "basketbal", "volleybal", "hockey", "bal", "sportkleding"] },
  "buiten": { categorySlug: "sport-en-vrije-tijd", subcategorySlug: "buiten-hiking", keywords: ["wandelen", "trekking", "kamperen", "tent", "rugzak", "slaapzak"] },

  // Hobby's
  "modelbouw": { categorySlug: "verzamelen", subcategorySlug: "modelbouw", keywords: ["modelbouw", "model bouw", "modeltreinen", "modelauto's", "schaalmodellen"] },
  "verzamelen": { categorySlug: "verzamelen", subcategorySlug: "verzamelen", keywords: ["verzamelen", "verzameling", "collectie", "postzegels", "munten", "stamps"] },
  "handwerk": { categorySlug: "verzamelen", subcategorySlug: "handwerk", keywords: ["handwerk", "knutselen", "tekenen", "schilderen", "breien", "haken", "creatief"] },

  // Muziek, Boeken & Films
  "boeken": { categorySlug: "boeken-en-media", subcategorySlug: "boeken", keywords: ["boeken", "boek", "literatuur", "leesboek", "leesboeken", "roman", "thriller"] },
  "instrumenten": { categorySlug: "muziek", subcategorySlug: "muziekinstrumenten", keywords: ["gitaar", "piano", "drum", "viool", "instrument", "muziek instrument"] },
  "vinyl": { categorySlug: "muziek", subcategorySlug: "lp-cd", keywords: ["lp", "cd", "vinyl", "grammofoonplaat", "muziek cd", "cd's"] },
  "films": { categorySlug: "film-en-series", subcategorySlug: "films", keywords: ["films", "film", "dvd", "blu-ray", "blueray", "videoband"] },

  // Games & Consoles
  "console": { categorySlug: "gaming", subcategorySlug: "consoles", keywords: ["console", "consoles", "playstation", "xbox", "nintendo", "switch", "ps5", "ps4"] },
  "games": { categorySlug: "gaming", subcategorySlug: "games", keywords: ["games", "spelletjes", "videogames", "computerspel", "computerspellen"] },
  "game-accessoires": { categorySlug: "gaming", subcategorySlug: "game-accessoires", keywords: ["controller", "gamepad", "headset gaming", "gaming muis"] },

    // Dieren
  "hond": { categorySlug: "dieren", subcategorySlug: "honden-katten", keywords: ["hond", "honden", "kat", "katten", "huisdier", "huisdieren", "puppy"] },
  "vogel": { categorySlug: "dieren", subcategorySlug: "vogels-knaagdieren", keywords: ["vogel", "vogels", "konijn", "konijnen", "hamster", "cavia", "parkiet"] },
  "dierenverzorging": { categorySlug: "dieren", subcategorySlug: "verzorging", keywords: ["mand", "bench", "dieren voeding", "dierenvoeding", "hondenvoer", "kattenvoer"] },

  // Doe-het-zelf
  "bouwmaterialen": { categorySlug: "bouw-en-gereedschap", subcategorySlug: "bouwmaterialen", keywords: ["hout", "cement", "stenen", "tegels", "bouw materiaal"] },
  "gereedschap": { categorySlug: "bouw-en-gereedschap", subcategorySlug: "gereedschap", keywords: ["boormachine", "zaag", "hamer", "schroevendraaier", "gereedschap"] },
  "sanitair": { categorySlug: "bouw-en-gereedschap", subcategorySlug: "sanitair-keuken", keywords: ["badkamer", "toilet", "kraan", "douche", "sanitair"] },

  // Caravans & Boten
  "caravan": { categorySlug: "caravans-en-kamperen", subcategorySlug: "caravans-campers", keywords: ["caravan", "camper", "woonwagen", "mobilhome", "caravans", "campers"] },
  "boot": { categorySlug: "watersport", subcategorySlug: "boten", keywords: ["boot", "boten", "vaartuig", "vaartuigen", "zeilboot", "motorboot"] },
  "caravan-onderdelen": { categorySlug: "caravans-en-kamperen", subcategorySlug: "onderdelen-accessoires", keywords: ["boot onderdelen", "caravan accessoires", "onderdelen accessoires"] },

  // Evenementen & Tickets
  "concert": { categorySlug: "evenementen", subcategorySlug: "concerten", keywords: ["concert", "concerten", "optreden", "optredens", "festival", "festivals"] },
  "pretpark": { categorySlug: "evenementen", subcategorySlug: "pretparken", keywords: ["pretpark", "pretparken", "attractiepark", "disneyland", "efteling"] },
  "sportevenement": { categorySlug: "evenementen", subcategorySlug: "sportevenementen", keywords: ["wedstrijd", "wedstrijden", "voetbal wedstrijd", "tennis", "sport event"] },

  // Diensten
  "reparatie": { categorySlug: "diensten", subcategorySlug: "herstellingen", keywords: ["reparatie", "reparaties", "repareren", "fix", "herstellen", "repair"] },
  "verhuis": { categorySlug: "diensten", subcategorySlug: "verhuis-transport", keywords: ["verhuis", "verhuizing", "transport", "vervoer", "verhuizing"] },
  "tuinonderhoud": { categorySlug: "diensten", subcategorySlug: "tuinonderhoud", keywords: ["tuinonderhoud", "tuin onderhoud", "grasmaaien", "snoeien", "tuinieren"] },

  // Vastgoed
  "te-koop": { categorySlug: "reizen", subcategorySlug: "te-koop", keywords: ["te koop", "verkopen", "verkoop", "huis verkopen", "appartement verkopen"] },
  "te-huur": { categorySlug: "reizen", subcategorySlug: "te-huur", keywords: ["te huur", "huren", "verhuur", "huis huren", "appartement huren"] },
  "vakantie": { categorySlug: "reizen", subcategorySlug: "vakantie", keywords: ["vakantie", "vakantieverhuur", "vakantiehuis", "vakantie appartement"] },

  // Gratis
  "gratis": { categorySlug: "gratis-en-ruilen", subcategorySlug: "alles-gratis", keywords: ["gratis", "kosteloos", "voor niets", "om niet", "cadeau", "weggeven", "free"] },

  // Doe-het-zelf
  "bouwmaterialen": { categorySlug: "fietsen"4, subcategorySlug: "bouwmaterialen", keywords: ["hout", "cement", "stenen", "tegels", "bouw materiaal"] },
  "gereedschap": { categorySlug: "fietsen"4, subcategorySlug: "gereedschap", keywords: ["boormachine", "zaag", "hamer", "schroevendraaier", "gereedschap"] },
  "sanitair": { categorySlug: "fietsen"4, subcategorySlug: "sanitair-keuken", keywords: ["badkamer", "toilet", "kraan", "douche", "sanitair"] },

  // Caravans & Boten
  "caravan": { categorySlug: "fietsen"5, subcategorySlug: "caravans-campers", keywords: ["caravan", "camper", "woonwagen", "mobilhome", "caravans", "campers"] },
  "boot": { categorySlug: "fietsen"5, subcategorySlug: "boten", keywords: ["boot", "boten", "vaartuig", "vaartuigen", "zeilboot", "motorboot"] },
  "caravan-onderdelen": { categorySlug: "fietsen"5, subcategorySlug: "onderdelen-accessoires", keywords: ["boot onderdelen", "caravan accessoires", "onderdelen accessoires"] },

  // Tickets & Evenementen
  "concert": { categorySlug: "fietsen"6, subcategorySlug: "concerten", keywords: ["concert", "concerten", "optreden", "optredens", "festival", "festivals"] },
  "pretpark": { categorySlug: "fietsen"6, subcategorySlug: "pretparken", keywords: ["pretpark", "pretparken", "attractiepark", "disneyland", "efteling"] },
  "sportevenement": { categorySlug: "fietsen"6, subcategorySlug: "sportevenementen", keywords: ["wedstrijd", "wedstrijden", "voetbal wedstrijd", "tennis", "sport event"] },

  // Diensten
  "reparatie": { categorySlug: "fietsen"7, subcategorySlug: "herstellingen", keywords: ["reparatie", "reparaties", "repareren", "fix", "herstellen", "repair"] },
  "verhuis": { categorySlug: "fietsen"7, subcategorySlug: "verhuis-transport", keywords: ["verhuis", "verhuizing", "transport", "vervoer", "verhuizing"] },
  "tuinonderhoud": { categorySlug: "fietsen"7, subcategorySlug: "tuinonderhoud", keywords: ["tuinonderhoud", "tuin onderhoud", "grasmaaien", "snoeien", "tuinieren"] },

  // Immo
  "te-koop": { categorySlug: "fietsen"8, subcategorySlug: "te-koop", keywords: ["te koop", "verkopen", "verkoop", "huis verkopen", "appartement verkopen"] },
  "te-huur": { categorySlug: "fietsen"8, subcategorySlug: "te-huur", keywords: ["te huur", "huren", "verhuur", "huis huren", "appartement huren"] },
  "vakantie": { categorySlug: "fietsen"8, subcategorySlug: "vakantie", keywords: ["vakantie", "vakantieverhuur", "vakantiehuis", "vakantie appartement"] },

  // Gratis
  "gratis": { categorySlug: "fietsen"9, subcategorySlug: "alles-gratis", keywords: ["gratis", "kosteloos", "voor niets", "om niet", "cadeau", "weggeven", "free"] },
};

/**
 * Detecteert automatisch categorie en subcategorie op basis van titel en beschrijving
 */
export function detectCategory(text: string): DetectedCategory | null {
  if (!text || text.trim().length < 3) return null;

  const lowerText = text.toLowerCase().trim();
  let bestMatch: DetectedCategory | null = null;
  let highestScore = 0;

  // Check elke categorie mapping
  for (const [, mapping] of Object.entries(categoryKeywords)) {
    for (const keyword of mapping.keywords) {
      if (lowerText.includes(keyword.toLowerCase())) {
        // Bereken score gebaseerd op keyword lengte en positie
        const score = keyword.length * (lowerText.indexOf(keyword.toLowerCase()) === 0 ? 2 : 1);

        if (score > highestScore) {
          highestScore = score;
          bestMatch = {
            categoryId: categorySlugToId[mapping.categorySlug] || 1,
            categorySlug: mapping.categorySlug,
            subcategorySlug: mapping.subcategorySlug,
            confidence: Math.min(score / 50, 1), // Max confidence van 1
            detectedLabel: keyword
          };
        }
      }
    }
  }

  return bestMatch;
}

/**
 * Geeft suggesties voor categorieën op basis van tekst
 */
export function suggestCategories(text: string, maxSuggestions: number = 3): DetectedCategory[] {
  if (!text || text.trim().length < 3) return [];

  const lowerText = text.toLowerCase().trim();
  const suggestions: DetectedCategory[] = [];

  // Check elke categorie mapping
  for (const [, mapping] of Object.entries(categoryKeywords)) {
    let totalScore = 0;
    let matchCount = 0;

    for (const keyword of mapping.keywords) {
      if (lowerText.includes(keyword.toLowerCase())) {
        const score = keyword.length * (lowerText.indexOf(keyword.toLowerCase()) === 0 ? 2 : 1);
        totalScore += score;
        matchCount++;
      }
    }

    if (matchCount > 0) {
      const avgScore = totalScore / matchCount;
      suggestions.push({
        categoryId: categorySlugToId[mapping.categorySlug] || 1,
        categorySlug: mapping.categorySlug,
        subcategorySlug: mapping.subcategorySlug,
        confidence: Math.min(avgScore / 30, 1)
      });
    }
  }

  // Sorteer op confidence en neem top resultaten
  return suggestions
    .sort((a, b) => b.confidence - a.confidence)
    .slice(0, maxSuggestions);
}

/**
 * Converteert category index naar category ID (voor database)
 */
export function categoryIndexToId(index: number): number {
  return index + 1; // Database gebruikt 1-based indexing
}

/**
 * Detecteert categorie op basis van afbeeldingsnamen (fallback systeem)
 */
export function detectCategoryFromFilenames(imageUrls: string[]): DetectedCategory | null {
  if (!imageUrls || imageUrls.length === 0) return null;

  // Combineer alle bestandsnamen en bekijk ze voor keywords
  const allText = imageUrls
    .map(url => {
      // Haal bestandsnaam uit URL
      const filename = url.split('/').pop()?.split('?')[0] || '';
      // Verwijder extensie en vervang underscores/spaties
      return filename.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ').toLowerCase();
    })
    .join(' ');

  return detectCategory(allText);
}

/**
 * Detecteert categorie op basis van lokale AI image recognition (CLIP model)
 */
export async function detectCategoryFromImageAnalysis(imageUrls: string[]): Promise<DetectedCategory | null> {
  if (!imageUrls || imageUrls.length === 0) return null;

  try {
    // Gebruik de lokale image search service voor category classification
    const response = await fetch('http://localhost:9000/classify', {
      method: 'POST',
      body: await createFormDataFromImageUrl(imageUrls[0]), // Gebruik eerste afbeelding
    });

    if (!response.ok) {
      console.warn('Local image classification failed:', response.status);
      return null;
    }

    const data = await response.json();

    if (!data.ok) return null;

    return {
      categoryIndex: data.category_index,
      subcategorySlug: data.subcategory_slug,
      confidence: data.confidence,
      detectedLabel: data.detected_label,
    };

  } catch (error) {
    console.error('Local image analysis failed:', error);
    return null;
  }
}

/**
 * Helper functie om FormData te maken van image URL
 */
async function createFormDataFromImageUrl(imageUrl: string): Promise<FormData> {
  try {
    // Download de afbeelding
    const imageResponse = await fetch(imageUrl);
    const imageBlob = await imageResponse.blob();

    // Maak FormData voor upload naar classification service
    const formData = new FormData();
    formData.append('file', imageBlob, 'image.jpg');

    return formData;
  } catch (error) {
    console.error('Failed to download image for classification:', error);
    throw error;
  }
}

/**
 * Combineert titel en afbeelding detectie voor betere resultaten
 * Gebruikt nu echte AI image recognition
 */
export async function detectCategorySmart(title: string, imageUrls: string[] = []): Promise<DetectedCategory | null> {
  // Probeer eerst op basis van titel
  const titleResult = detectCategory(title);
  if (titleResult && titleResult.confidence > 0.4) {
    return titleResult;
  }

  // Als titel niet voldoende is, probeer AI image analysis
  if (imageUrls.length > 0) {
    const imageResult = await detectCategoryFromImageAnalysis(imageUrls);
    if (imageResult) {
      return imageResult;
    }
  }

  // Fallback naar bestandsnaam analyse
  const filenameResult = detectCategoryFromFilenames(imageUrls);
  if (filenameResult && filenameResult.confidence > 0.3) {
    return filenameResult;
  }

  // Geef de beste van beide terug
  if (titleResult && filenameResult) {
    return titleResult.confidence > filenameResult.confidence ? titleResult : filenameResult;
  }

  return titleResult || filenameResult;
}
